---
title: "SMM634 Group Assignment"
subtitle: "Actuarial Science: Group 4"
author:
  - "Ardi Wira Sudarmo"
  - "Basmah Khan"
  - "Chengetanayi Dyirakumunda"
  - "Benjamin Evans"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    self_contained: true
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    theme: flatly
    highlight: tango
    df_print: paged
---

## BE note:

Use `rmarkdown::render("MSc_AS-SMM634-Group4-Project.rmd", output_dir = "docs")`
to render...

# Identifying the variables

## Reading & cleaning data and preliminary analysis

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE,
  fig.align = "center", fig.width = 7, fig.height = 5
)

# # Packages
# install.packages(c("tidyverse","janitor","broom","car","MASS","GGally","glue","scales","lmtest"))
# need <- c(
#   "tidyverse","janitor","broom","car","MASS","GGally",
#   "glue","scales","lmtest"
# )
# to_install <- setdiff(need, rownames(installed.packages()))
# if (length(to_install)) install.packages(to_install, quiet = TRUE)
# invisible(lapply(need, library, character.only = TRUE))
library(tidyverse)   # loads dplyr, ggplot2, readr, stringr, forcats, etc.
library(janitor)
library(broom)
library(car)
library(MASS)
library(GGally)
library(glue)
library(scales)
library(lmtest)

```

### Reading in data (& showing summary)

```{r}
df <- readr::read_csv("car_price.csv", show_col_types = FALSE)
summary(df)
```

### Cleaning

```{r}
df <- janitor::clean_names(df)

expected <- c(
  "car_id","symboling","carname","fueltype","aspiration","doornumber",
  "carbody","drivewheel","enginelocation","wheelbase","carlength","carwidth",
  "carheight","curbweight","enginetype","cylindernumber","enginesize","fuelsystem",
  "boreratio","stroke","compressionratio","horsepower","peakrpm","citympg",
  "highwaympg","price"
)
missing <- setdiff(expected, names(df))
if (length(missing) > 0) {
  warning(glue::glue("Missing columns (after cleaning): {toString(missing)}"))
}
```

### Factorise categorical variables

```{r}
cat_vars <- c(
  "fueltype","aspiration","doornumber","carbody","drivewheel",
  "enginelocation","enginetype","cylindernumber","fuelsystem","brand"
)
for (v in intersect(cat_vars, names(df))) df[[v]] <- as.factor(df[[v]])

# Derived variables
if ("price" %in% names(df)) {
  df <- df |>
    mutate(
      log_price = log(price),
      doors_num = if ("doornumber" %in% names(df)) dplyr::recode(doornumber, two = 2L, four = 4L, .default = NA_integer_) else NA_integer_
    )
}

rows <- nrow(df); cols <- ncol(df)
# quick check
stopifnot("price" %in% names(df))
```

### Quick visualisation

```{r}
p1 <- ggplot(df, aes(price)) +
  geom_histogram(bins = 30) +
  labs(title = "Price (raw)")
p2 <- ggplot(df, aes(log_price)) +
  geom_histogram(bins = 30) +
  labs(title = "Price (log)")

# Correlations among numerics

num_vars <- c(
  "wheelbase", "carlength", "carwidth", "carheight", "curbweight",
  "enginesize", "boreratio", "stroke", "compressionratio", "horsepower",
  "peakrpm", "citympg", "highwaympg", "symboling"
)
keep_num <- intersect(num_vars, names(df))
p_cor <- GGally::ggcorr(
  df[, keep_num],
  label = TRUE, label_round = 2, hjust = 0.8, size = 3
) +
  labs(title = "Correlation (numeric regressors)")

# Boxplots of log_price by key categoricals (if present)

plot_cat <- function(var) {
  if (var %in% names(df)) {
    ggplot(df, aes(.data[[var]], log_price)) +
      geom_boxplot() +
      labs(title = paste("log_price by", var), x = var, y = "log_price") +
      theme(axis.text.x = element_text(angle = 30, hjust = 1))
  } else {
    NULL
  }
}
p_cat1 <- plot_cat("fueltype")
p_cat2 <- plot_cat("carbody")
p_cat3 <- plot_cat("drivewheel")
```

```{r}
p1
p2
```

```{r}
p_cor
```

```{r}
p_cat1
p_cat2
p_cat3
```

# Fitting General Linear Response Model

TBI

# Summarising and Interpreting the Results

TBI

# Limitations

TBI

# Suggestions for Improvements

TBI
