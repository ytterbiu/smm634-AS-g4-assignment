---
title: "SMM634 Group Assignment"
subtitle: "Actuarial Science: Group 4"
author:
  - "Ardi Wira Sudarmo"
  - "Basmah Khan"
  - "Chengetanayi Dyirakumunda"
  - "Benjamin Evans"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    self_contained: true
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    theme: flatly
    highlight: tango
    df_print: paged
---

## BE note:

Use `rmarkdown::render("MSc_AS-SMM634-Group4-Project.rmd", output_dir = "docs")`
to render...

# Initial processing

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE,
  fig.align = "center", fig.width = 7, fig.height = 5
)
```

```{r}
## dependencies / external librarys
library(dplyr)
library(ggplot2)
library(car)
library(MASS)
```

## Read Data

```{r}
rm(list = ls())
# CarDataRead.R

# source(file.path(".", "CarDataRead.R"))
df <- read.csv("car_price.csv") |>
  mutate(fsymboling = as.factor(symboling)) |>
  mutate(safety = case_match(
    symboling,
    c(-2, -1) ~ "<-1",
    0 ~ "0",
    1 ~ "1",
    2 ~ "2",
    3 ~ "3"
  )) |>
  mutate(safetyIncr = case_match(
    symboling,
    c(-2, -1) ~ "4",
    0 ~ "3",
    1 ~ "2",
    2 ~ "1",
    3 ~ "0"
  )) |>
  mutate(safetyIncr2 = case_match(
    symboling,
    0 ~ "Base",
    c(-2, -1) ~ "Safer",
    c(1, 2, 3) ~ "Riskier"
  )) |>
  mutate(cylinderNum = case_match(cylindernumber,
    c("two", "three") ~ "leq_three",
    c("eight", "twelve") ~ "geq_eight",
    .default = cylindernumber
  ))

table(df$cylinderNum)
```

### Clean data

Want to check for any typos, missing data, or NaN values.

### Car manufacturer

Extracting car manufacturer from first part of `CarName` and correcting spelling
errors. Our assumptions are as follows:

| Typo / Mis-spelling | Correct Spelling |
| ------------------- | ---------------- |
| maxda               | mazda            |
| Nissan              | nissan           |
| porcshce            | porsche          |
| toyouta             | toyota           |
| vokswagen           | volkswagen       |
| vw                  | volkswagen       |

```{r}
# extract car manufacturer from first part of CarName
df$carManufacturer <- sapply(strsplit(df$CarName, " +"), `[`, 1)
# print
table(df$carManufacturer)

df <- df %>% mutate(carManufacturer = case_match(carManufacturer,
  "maxda" ~ "mazda",
  "Nissan" ~ "nissan",
  "porcshce" ~ "porsche",
  "toyouta" ~ "toyota",
  c("vokswagen", "vw") ~ "volkswagen",
  .default = carManufacturer
))
table(df$carManufacturer)
```

### NA value check

```{r}
# check individual columns for NaN values
colSums(is.na(df))
# check total number of NaN values
cat(c("Total number of NaN values:", sum(colSums(is.na(df)))))
```

Looks good - no NaN values.

## Data examination & visualisation

### Overview

```{r}
summary(df)
str(df)
```

### Factor variables: General

```{r}
table(df$symboling)
table(df$safety)
table(df$safetyIncr)

table(df$cylindernumber)
table(df$cylinderNum)
```

```{r}
# factor_cols <- c("symboling", "safety", "safetyIncr", "cylindernumber", "cylinderNum","carbody")
# examine categorical fields
factor_cols<- c(
  "symboling",
  "safety",
  "safetyIncr",
  "safetyIncr2",
  "cylindernumber",
  "cylinderNum",
  "carbody",
  "fueltype",
  "aspiration",
  "doornumber",
  "carbody",
  "drivewheel",
  "enginelocation", # BE note: 202:3 split so don't include in model
  "enginetype",
  "cylindernumber",
  "fuelsystem",
  "carManufacturer"
)

cols_use <- unique(intersect(factor_cols, names(df)))
fc_missing <- setdiff(unique(factor_cols), names(df))
if (length(fc_missing)) {
  message(
    "Missing in df (skipped): ",
    paste(fc_missing, collapse = ", ")
  )
}
tab_list <- setNames(
  lapply(cols_use, function(v) table(df[[v]], useNA = "ifany")),
  # lapply(cols_use, function(v) prop.table(table(df[[v]], useNA = "ifany"))),
  cols_use
)
for (nm in names(tab_list)) {
  cat("\n==== ", nm, " ====\n", sep = "")
  print(tab_list[[nm]])
}
```

```{r}
df <- df %>%
  mutate(across(all_of(factor_cols), as.factor))
```

### Factor variables: check stored as factors in R

```{r}
str(df)
```

### Visualisation

Have chosen `price` as response variable. Want to see how it's distributed...
(might want to use log(price) as used in Intro to Python).

```{r}
ggplot(df, aes(x = price)) +
  geom_histogram(bins = 30, fill = "blue", alpha = 0.7) +
  ggtitle("Distribution of Car Prices")
```

Look at numerical variables vs price

```{r}
# price vs horsepower
ggplot(df, aes(x = horsepower, y = price)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  ggtitle("Price vs Horsepower") +
  theme_minimal()

# Price vs engine size
ggplot(df, aes(x = enginesize, y = price)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  ggtitle("Price vs Engine Size") +
  theme_minimal()

# Price vs highwaympg (could also use citympg)
ggplot(df, aes(x = highwaympg, y = price)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  ggtitle("Price vs MPG (Highway)") +
  theme_minimal()

# Price vs citympg (note: city vs highwaympg are likely to be correlated)
ggplot(df, aes(x = citympg, y = price)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  ggtitle("Price vs MPG (City)") +
  theme_minimal()

```

This is only a quick look, but clear issues with negative price assuming simple
linear regression > ~40 mpg for both city and highway mpg

```{r}
# Price vs fuel type

ggplot(df, aes(x = fueltype, y = price)) +
  geom_boxplot() +
  ggtitle("Price
Distribution by Fuel Type") +
  theme_minimal()

# Price vs car body

ggplot(df, aes(x = carbody, y = price)) +
  geom_boxplot() +
  ggtitle("Price
Distribution by Car Body") +
  theme_minimal()

# Price vs (new) manufacturer

ggplot(df, aes(x = carManufacturer, y = price)) +
  geom_boxplot() +
  ggtitle("Price Distribution by Manufacturer") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

This is not unexpected, but is quite interesting to see. Some manufacturers are
more expensive (& the range of models produced is also variable).

Based upon our personal investigation & search we think the data we have been
given here are a subset of the data from 1985 Ward's Automotive Yearbook (with a
more comprehensive data set being available from
https://archive.ics.uci.edu/dataset/10/automobile).

Note, this doesn't consider companies that own other companies (i.e., Toyota
currently owns Lexus, but both could be considered to be toyota despite both
having different price points. This consideration is something we decided was
beyond the scope of this analysis).

# Pricing Assistant Model

Our main goal is to get an accurate predicted price $$\hat{y}$$ for a new
car.

Note, to build a good pricing assistant, we must check p-values, interpret
coefficients to ensure the model is valid - this chimes with goals of assessment
and lecture content

## Fitting General Linear Response Model

TBI

# Summarising and Interpreting the Results

TBI

# Limitations

TBI

# Suggestions for Improvements

TBI
